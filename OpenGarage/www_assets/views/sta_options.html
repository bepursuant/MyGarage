<body>
	<div data-role='page' id='page_opts'>
		<div data-role='header'><h3>Edit Options</h3></div>    
		<div data-role='content'>   
			<table cellpadding=2>
			<tr><td><b>Accessibility:</b></td><td>
			<select name='access_mode' id='access_mode' data-mini='true'>
			<option value=0>Direct IP Only</option>
			<option value=1>Direct IP + Cloud</option>                  
			<option value=2>Cloud Only</option>
			</select></td></tr>      
			<tr><td><b>Cloud Token:</b></td><td><input type='text' size=24 maxlength=32 id='auth' data-mini='true' value='-'></td></tr>
			<tr><td><b>Mount Type:</b></td><td>
			<select name='mount_type' id='mount_type' data-mini='true'>
			<option value=0>Ceiling Mount</option>
			<option value=1>Side Mount</option>
			</select></td></tr> 
			<tr><td><b>Threshold (cm): </b></td><td><input type='text' size=4 maxlength=4 id='dth' data-mini='true' value=1></td></tr>
			<tr><td><b>Read Interval (s):</b></td><td><input type='text' size=3 maxlength=3 id='read_interval' data-mini='true' value=1></td></tr>
			<tr><td><b>Sound Alarm:</b></td><td>
			<select name='alarm' id='alarm' data-mini='true'>      
			<option value=0>Disabled</option>
			<option value=1>5 seconds</option>                  
			<option value=2>10 seconds</option>      
			</select></td></tr>
			<tr><td><b>Device Name:</b></td><td><input type='text' size=20 maxlength=32 id='name' data-mini='true' value='-'></td></tr>
			<tr><td><b>HTTP Port:</b></td><td><input type='text' size=5 maxlength=5 id='http_port' value=1 data-mini='true'></td></tr>
			<tr><td><b>Device Key:</b></td><td><input type='password' size=24 maxlength=32 id='devicekey' data-mini='true'></td></tr>
			<tr><td colspan=2><p id='msg'></p></td></tr>
			<tr><td colspan=2><input type='checkbox' data-mini='true' id='cb_key'><label for='cb_key'>Change Device Key</label></td></tr>
			<tr><td><b>New Key:</b></td><td><input type='password' size=24 maxlength=32 id='nkey' data-mini='true' disabled></td></tr>
			<tr><td><b>Confirm:</b></td><td><input type='password' size=24 maxlength=32 id='ckey' data-mini='true' disabled></td></tr>  
			</table>
			<div data-role='controlgroup' data-type='horizontal'>
			<a href='#' data-role='button' data-inline='true' data-theme='a' id='btn_cancel'>Cancel</a>
			<a href='#' data-role='button' data-inline='true' data-theme='b' id='btn_submit'>Submit</a>      
			</div>
		</div>
		<div data-role='footer' data-theme='c'>
			<p>&nbsp; OpenGarage Firmware <label id='firmware_version'>-</label>&nbsp;<a href="update" target='_blank' data-role='button' data-inline=true data-mini=true>Update</a></p>
		</div> 
	</div>
	<script>
		//#msg acts as a response container for events
		function clear_msg() {
			$('#msg').text('');
		}  

		function show_msg(s) {
			$('#msg').text(s).css('color','red');
			setTimeout(clear_msg, 2000);
		}

		// enable/disable the change key textboxes when the 'change key'
		// checkbox is changed
		$('#cb_key').click(function(e){
			$('#nkey').textinput($(this).is(':checked')?'enable':'disable');
			$('#ckey').textinput($(this).is(':checked')?'enable':'disable');
		});

		$('#btn_cancel').click(function(e){
			e.preventDefault(); close();
		});
		
		$('#btn_submit').click(function(e){
			e.preventDefault();
			if(confirm('Submit changes?')) {
				var comm='controller?devicekey='+encodeURIComponent($('#devicekey').val());
				comm+='&access_mode='+$('#access_mode').val();
				comm+='&mount_type='+$('#mount_type').val();
				comm+='&dth='+$('#dth').val();
				comm+='&read_interval='+$('#read_interval').val();
				comm+='&alarm='+$('#alarm').val();
				comm+='&http_port='+$('#http_port').val();
				comm+='&name='+encodeURIComponent($('#name').val());
				comm+='&auth='+encodeURIComponent($('#auth').val());
				if($('#cb_key').is(':checked')) {
					if(!$('#nkey').val()) {
						if(!confirm('New device key is empty. Are you sure?')) return;
					}
					comm+='&nkey='+encodeURIComponent($('#nkey').val());
					comm+='&ckey='+encodeURIComponent($('#ckey').val());
				}
				$.getJSON(comm, function(jd) {
					if(jd.result!=1) {
						if(jd.result==2) show_msg('Check device key and try again.');
						else show_msg('Error code: '+jd.result+', item: '+jd.item);
					} else {
						$('#msg').html('<font color=green>Options are successfully saved. Note that<br>changes to some options may require a reboot.</font>');
						$('#btn_submit').
						setTimeout(close, 4000);
					}
				});
			}
		});

		$(document).ready(function() {
			$.getJSON('/json/options', function(jd) {
				$('#firmware_version').text('v'+(jd.firmware_version/100>>0)+'.'+(jd.firmware_version/10%10>>0)+'.'+(jd.firmware_version%10>>0));
				$('#access_mode').val(jd.access_mode).selectmenu('refresh');
				$('#alarm').val(jd.alarm).selectmenu('refresh');
				$('#mount_type').val(jd.mount_type).selectmenu('refresh');
				$('#dth').val(jd.dth);
				$('#read_interval').val(jd.read_interval);
				$('#http_port').val(jd.http_port);
				$('#name').val(jd.name);
				$('#auth').val(jd.auth);
			});
		});
	</script>
</body>